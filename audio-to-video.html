<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio to Video è‡ªå‹•åˆæˆå™¨</title>
    <script src="coi-serviceworker.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-2xl">
        <h1 class="text-2xl font-bold text-gray-800 mb-6 text-center">ğŸµ éŸ³è¨Šè½‰å½±ç‰‡ (è‡ªå‹•ç”Ÿæˆå°é¢)</h1>
        
        <div class="space-y-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">é¸æ“‡éŸ³è¨Šæª” (.mp3 / .m4a / .wav)</label>
                <div class="flex items-center justify-center w-full">
                    <label for="audio-upload" class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-blue-300 rounded-lg cursor-pointer bg-blue-50 hover:bg-blue-100 transition-colors">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6">
                            <svg class="w-8 h-8 mb-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path></svg>
                            <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">é»æ“Šä¸Šå‚³éŸ³æª”</span></p>
                            <p id="file-name-display" class="text-xs text-gray-500">æ”¯æ´é•·æ™‚é–“éŒ„éŸ³æª”</p>
                        </div>
                        <input id="audio-upload" type="file" accept="audio/*" class="hidden" />
                    </label>
                </div>
            </div>

            <div id="preview-area" class="hidden text-center">
                <p class="text-sm text-gray-500 mb-2">å°‡ä½¿ç”¨æ­¤è‡ªå‹•ç”Ÿæˆçš„å°é¢ï¼š</p>
                <img id="cover-preview" class="mx-auto rounded shadow-md max-h-48 border border-gray-200" />
            </div>

            <button id="convert-btn" disabled class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                é–‹å§‹è½‰æª” (Start FFmpeg)
            </button>

            <div id="status-area" class="hidden bg-gray-50 p-4 rounded-lg border border-gray-200 text-sm font-mono text-gray-600 max-h-40 overflow-y-auto">
                <p>ç­‰å¾…æŒ‡ä»¤...</p>
            </div>

            <div id="result-area" class="hidden text-center">
                <h3 class="text-lg font-bold text-gray-800 mb-2">ğŸ‰ è½‰æª”å®Œæˆï¼</h3>
                <video id="output-video" controls class="w-full rounded-lg shadow-md mb-4 bg-black"></video>
                <a id="download-link" class="inline-block bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-full transition-colors">
                    ä¸‹è¼‰å½±ç‰‡
                </a>
            </div>
        </div>
    </div>

    <script>
        const { createFFmpeg, fetchFile } = FFmpeg;
        const ffmpeg = createFFmpeg({ log: true });

        const audioInput = document.getElementById('audio-upload');
        const fileNameDisplay = document.getElementById('file-name-display');
        const convertBtn = document.getElementById('convert-btn');
        const statusArea = document.getElementById('status-area');
        const resultArea = document.getElementById('result-area');
        const outputVideo = document.getElementById('output-video');
        const downloadLink = document.getElementById('download-link');
        const previewArea = document.getElementById('preview-area');
        const coverPreview = document.getElementById('cover-preview');

        let generatedImageBlob = null; // å„²å­˜ç”Ÿæˆçš„åœ–ç‰‡ Blob

        const log = (message) => {
            statusArea.innerHTML += `<p>> ${message}</p>`;
            statusArea.scrollTop = statusArea.scrollHeight;
        };

        // â˜… æ–°å¢åŠŸèƒ½ï¼šå‹•æ…‹ç”Ÿæˆåœ–ç‰‡å‡½å¼
        function generateImageFromText(text) {
            const canvas = document.createElement('canvas');
            // è¨­å®šç•«å¸ƒå¤§å° (ç‚ºäº†çœè¨˜æ†¶é«”ï¼Œæˆ‘å€‘ç›´æ¥è¨­å®šç‚º 854x480ï¼Œå³ 480p)
            canvas.width = 854;
            canvas.height = 480;
            const ctx = canvas.getContext('2d');

            // 1. ç¹ªè£½èƒŒæ™¯ (æ·±è—è‰²æ¼¸å±¤)
            const gradient = ctx.createLinearGradient(0, 0, 854, 480);
            gradient.addColorStop(0, '#1e3a8a'); // blue-900
            gradient.addColorStop(1, '#3b82f6'); // blue-500
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 2. ç¹ªè£½æ–‡å­—
            ctx.fillStyle = 'white';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            // è‡ªå‹•èª¿æ•´å­—å‹å¤§å°
            let fontSize = 40;
            ctx.font = `bold ${fontSize}px Arial`;
            
            // ç°¡å–®çš„æ–‡å­—æ›è¡Œé‚è¼¯ (å¦‚æœå¤ªé•·)
            const maxWidth = 800;
            const words = text.split(' ');
            let line = '';
            let lines = [];
            
            // é€™è£¡ç°¡åŒ–è™•ç†ï¼šç›´æ¥æŠŠæª”åå°åœ¨ä¸­é–“ï¼Œå¦‚æœå¤ªé•·å°±æˆªæ–·
            if (ctx.measureText(text).width > maxWidth) {
                fontSize = 30; // ç¸®å°å­—é«”
                ctx.font = `bold ${fontSize}px Arial`;
            }
            
            ctx.fillText(text, canvas.width / 2, canvas.height / 2);
            
            // 3. æ·»åŠ ä¸€å€‹è£é£¾åœ–ç¤º (éŸ³ç¬¦)
            ctx.font = '60px Arial';
            ctx.fillText('ğŸµ', canvas.width / 2, canvas.height / 2 - 80);

            // 4. è½‰ç‚º Blob
            return new Promise(resolve => {
                canvas.toBlob(blob => {
                    resolve(blob);
                }, 'image/jpeg', 0.9);
            });
        }

        // ç›£è½æª”æ¡ˆé¸æ“‡
        audioInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                fileNameDisplay.innerText = file.name;
                
                // ç«‹å³ç”Ÿæˆå°é¢åœ–
                const fileName = file.name;
                generatedImageBlob = await generateImageFromText(fileName);
                
                // é¡¯ç¤ºé è¦½
                const url = URL.createObjectURL(generatedImageBlob);
                coverPreview.src = url;
                previewArea.classList.remove('hidden');
                
                convertBtn.disabled = false;
            }
        });

        convertBtn.addEventListener('click', async () => {
            const audioFile = audioInput.files[0];

            if (!audioFile || !generatedImageBlob) {
                alert('è«‹å…ˆé¸æ“‡éŸ³æª”ï¼');
                return;
            }

            // UI ç‹€æ…‹æ›´æ–°
            convertBtn.disabled = true;
            convertBtn.innerText = "è™•ç†ä¸­... (ç€è¦½å™¨é‹ç®—ä¸­)";
            statusArea.classList.remove('hidden');
            resultArea.classList.add('hidden');
            statusArea.innerHTML = '';

            // æª¢æŸ¥ç’°å¢ƒ
            if (!window.crossOriginIsolated) {
                log("âš ï¸ è­¦å‘Šï¼šSharedArrayBuffer æœªå•Ÿç”¨ï¼Œå¯èƒ½æœƒè½‰æª”å¤±æ•—ã€‚è«‹æª¢æŸ¥ coi-serviceworkerã€‚");
            }

            try {
                if (!ffmpeg.isLoaded()) {
                    log('è¼‰å…¥ FFmpeg æ ¸å¿ƒ...');
                    await ffmpeg.load();
                }

                const imgName = 'cover.jpg';
                const audioName = 'input_audio.m4a'; // çµ±ä¸€åç¨±æ–¹ä¾¿è™•ç†
                
                log('å¯«å…¥æª”æ¡ˆåˆ°è™›æ“¬è¨˜æ†¶é«”...');
                // å¯«å…¥ç”Ÿæˆçš„åœ–ç‰‡
                ffmpeg.FS('writeFile', imgName, await fetchFile(generatedImageBlob));
                // å¯«å…¥ä¸Šå‚³çš„éŸ³æª”
                ffmpeg.FS('writeFile', audioName, await fetchFile(audioFile));

                log('ğŸš€ å•Ÿå‹•æ¥µé™çœè³‡æºæ¨¡å¼ (Audio + Static Image)...');
                
                // åŸ·è¡Œè½‰æª”æŒ‡ä»¤
                await ffmpeg.run(
                    '-loop', '1',           // åœ–ç‰‡ç„¡é™å¾ªç’°
                    '-framerate', '1',      // è¼¸å…¥å¹€ç‡è¨­ç‚º 1fps (æ¥µçœè¨˜æ†¶é«”)
                    '-i', imgName,          // è¼¸å…¥åœ–ç‰‡
                    '-i', audioName,        // è¼¸å…¥éŸ³æª”
                    
                    // ä¸éœ€è¦ scale äº†ï¼Œå› ç‚ºæˆ‘å€‘ç”Ÿæˆåœ–ç‰‡æ™‚å·²ç¶“æ§åˆ¶åœ¨ 854x480
                    // '-vf', 'scale=854:-2', 
                    
                    '-c:v', 'libx264',      // å½±åƒç·¨ç¢¼
                    '-preset', 'ultrafast', // æœ€å¿«é€Ÿåº¦
                    '-tune', 'stillimage',  // éœæ…‹åœ–å„ªåŒ–
                    
                    '-r', '1',              // è¼¸å‡ºå½±ç‰‡å¹€ç‡å¼·åˆ¶ 1fps (é—œéµ!)
                    '-b:v', '500k',         // é™åˆ¶å½±åƒä½å…ƒç‡
                    
                    '-c:a', 'copy',         // éŸ³è¨Šç›´æ¥è¤‡è£½ (ä¸é‡ç·¨ç¢¼ï¼Œæœ€å¿«ä¸”ç„¡æ)
                    '-pix_fmt', 'yuv420p',  // ç›¸å®¹æ€§è¨­å®š
                    '-shortest',            // å½±ç‰‡é•·åº¦ç­‰æ–¼éŸ³è¨Šé•·åº¦
                    'output.mp4'
                );

                log('è½‰æª”å®Œæˆï¼æº–å‚™ä¸‹è¼‰...');

                const data = ffmpeg.FS('readFile', 'output.mp4');
                const videoBlob = new Blob([data.buffer], { type: 'video/mp4' });
                const videoUrl = URL.createObjectURL(videoBlob);

                outputVideo.src = videoUrl;
                downloadLink.href = videoUrl;
                downloadLink.download = `${audioFile.name.split('.')[0]}.mp4`; // æª”åè·Ÿéš¨éŸ³æª”

                resultArea.classList.remove('hidden');
                log('âœ… å…¨éƒ¨å®Œæˆï¼');

            } catch (error) {
                console.error(error);
                log(`âŒ éŒ¯èª¤: ${error.message}`);
                alert('è½‰æª”å¤±æ•—ï¼Œè«‹ç¢ºèªè¨˜æ†¶é«”æ˜¯å¦è¶³å¤ æˆ–æª”æ¡ˆæ˜¯å¦ææ¯€ã€‚');
            } finally {
                convertBtn.disabled = false;
                convertBtn.innerText = "é–‹å§‹è½‰æª” (Start FFmpeg)";
            }
        });
    </script>
</body>
</html>